<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BakeBase - Professional Recipe Manager</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Professional Recipe & Allergen Management for Bakers">
    <meta name="theme-color" content="#81c9c9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BakeBase">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Fonts removed for offline use -->
    <style>
        :root {
            --color-teal: #81c9c9;
            --color-teal-dark: #6bb3b3;
            --color-purple: #b8a8d4;
            --color-purple-dark: #a395c4;
            --color-pink: #f5c6d6;
            --color-pink-dark: #eab3c9;
            --color-accent: #2b7a8e;
            --color-text: #333;
            --color-text-light: #666;
            --color-bg-light: #f8fcfc;
            --color-border: #d1e9e9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--color-teal) 0%, var(--color-purple) 50%, var(--color-pink) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-container {
            margin-bottom: 15px;
        }

        .custom-logo {
            max-width: 200px;
            max-height: 120px;
            height: auto;
            border-radius: 8px;
        }

        h1 {
            color: var(--color-accent);
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            color: rgba(43, 122, 142, 0.8);
            font-size: 1.1em;
            font-weight: 300;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 30px;
            background: rgba(255,255,255,0.3);
            color: var(--color-accent);
            border: 2px solid var(--color-teal);
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: white;
            color: var(--color-accent);
            border-color: var(--color-accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(43, 122, 142, 0.15);
        }

        .card h2 {
            color: var(--color-accent);
            font-family: Georgia, 'Times New Roman', serif;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--color-text);
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--color-teal);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-light);
        }

        .ingredient-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .ingredient-input input,
        .ingredient-input select {
            flex: 1;
        }

        .ingredient-input button {
            padding: 10px 20px;
            background: var(--color-teal);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .ingredient-input button:hover {
            background: var(--color-teal-dark);
            transform: translateY(-2px);
        }

        .ingredient-list {
            list-style: none;
            margin-top: 10px;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--color-bg-light);
            border-left: 4px solid var(--color-teal);
            border-radius: 6px;
            margin-bottom: 8px;
            transition: transform 0.2s;
        }

        .ingredient-item:hover {
            transform: translateX(5px);
        }

        .ingredient-item .allergen-badge {
            background: var(--color-pink);
            color: #8b4561;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
            font-weight: 600;
        }

        .ingredient-item button {
            background: var(--color-pink);
            color: #8b4561;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .ingredient-item button:hover {
            background: var(--color-pink-dark);
        }

        .ingredient-details {
            font-size: 12px;
            color: var(--color-text-light);
            margin-top: 5px;
        }

        .category-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .category-pill {
            padding: 6px 15px;
            background: var(--color-bg-light);
            border: 2px solid var(--color-teal);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .category-pill:hover {
            background: var(--color-teal);
            color: white;
        }

        .category-pill.active {
            background: var(--color-teal);
            color: white;
        }

        .allergen-checkboxes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .allergen-checkboxes label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }

        .allergen-checkboxes input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            accent-color: var(--color-teal);
        }



        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--color-teal) 0%, var(--color-purple) 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(43, 122, 142, 0.3);
        }

        .theme-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--color-bg-light);
            border-radius: 8px;
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .theme-option {
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .theme-option:hover {
            transform: scale(1.05);
        }

        .theme-option.active {
            border-color: var(--color-accent);
        }

        .export-import-section {
            margin-top: 20px;
            padding: 20px;
            background: var(--color-bg-light);
            border: 2px solid var(--color-border);
            border-radius: 8px;
        }

        .export-import-section h3 {
            color: var(--color-accent);
            font-family: Georgia, 'Times New Roman', serif;
            margin-bottom: 15px;
        }

        .export-import-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .export-import-buttons button {
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: white;
            transition: all 0.3s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .btn-export {
            background: var(--color-teal);
        }

        .btn-export:hover {
            background: var(--color-teal-dark);
        }

        .btn-import {
            background: var(--color-purple);
        }

        .btn-import:hover {
            background: var(--color-purple-dark);
        }

        input[type="file"] {
            display: none;
        }

        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .recipe-card {
            background: white;
            border-radius: 8px;
            padding: 12px 15px;
            box-shadow: 0 2px 8px rgba(43, 122, 142, 0.08);
            transition: all 0.3s;
            border-left: 3px solid var(--color-teal);
        }

        .recipe-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(43, 122, 142, 0.15);
        }

        .recipe-card {
            cursor: pointer;
        }

        .recipe-card.selected {
            border-left-color: var(--color-purple);
            background: linear-gradient(135deg, rgba(129, 201, 201, 0.08) 0%, rgba(184, 168, 212, 0.08) 100%);
            box-shadow: 0 4px 15px rgba(43, 122, 142, 0.2);
        }

        .recipe-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--color-teal);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .recipe-card h3 {
            color: var(--color-accent);
            font-family: Georgia, 'Times New Roman', serif;
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .recipe-card .category-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--color-teal);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .recipe-card p {
            color: var(--color-text-light);
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .recipe-allergens {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }

        .recipe-allergens span {
            background: var(--color-pink);
            color: #8b4561;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .recipe-actions {
            display: flex;
            gap: 6px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .recipe-actions button {
            flex: 1;
            min-width: 70px;
            padding: 7px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 11px;
            transition: all 0.3s;
        }

        .btn-print-full {
            background: var(--color-teal);
            color: white;
        }

        .btn-print-full:hover {
            background: var(--color-teal-dark);
        }

        .btn-print-simple {
            background: var(--color-purple);
            color: white;
        }

        .btn-print-simple:hover {
            background: var(--color-purple-dark);
        }


        .btn-scale {
            background: #ffa726;
            color: white;
        }

        .btn-scale:hover {
            background: #ff9800;
        }

        .multiplier-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--color-teal);
            background: white;
            color: var(--color-accent);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .multiplier-btn:hover, .multiplier-btn.active {
            background: var(--color-teal);
            color: white;
        }

        .btn-view {
            background: #42a5f5;
            color: white;
        }

        .btn-view:hover {
            background: #1e88e5;
        }

        .btn-delete {
            background: var(--color-pink);
            color: #8b4561;
        }

        .btn-delete:hover {
            background: var(--color-pink-dark);
        }

        .master-ingredient-card {
            background: var(--color-bg-light);
            border: 2px solid var(--color-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .master-ingredient-card:hover {
            box-shadow: 0 4px 12px rgba(43, 122, 142, 0.1);
        }

        .master-ingredient-card h4 {
            color: var(--color-accent);
            font-family: Georgia, 'Times New Roman', serif;
            margin-bottom: 10px;
        }

        .master-ingredient-card .composition {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .master-ingredient-card .actions {
            display: flex;
            gap: 10px;
        }

        .master-ingredient-card button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(43, 122, 142, 0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border-top: 4px solid var(--color-teal);
        }

        .modal-content h3 {
            color: var(--color-accent);
            font-family: Georgia, 'Times New Roman', serif;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }


        .print-content {
            display: none;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container,
            .main-content,
            .recipes-grid,
            .tabs {
                display: none !important;
            }

            .print-content {
                display: block !important;
                padding: 20px;
                max-width: 800px;
                margin: 0 auto;
            }

            .print-content h1 {
                color: var(--color-accent);
                margin-bottom: 20px;
                text-shadow: none;
                font-family: Georgia, 'Times New Roman', serif;
            }

            .print-content h2 {
                color: var(--color-accent);
                margin-top: 20px;
                margin-bottom: 10px;
                font-family: Georgia, 'Times New Roman', serif;
            }

            .print-content .allergen-warning {
                background: var(--color-pink);
                border: 2px solid var(--color-pink-dark);
                padding: 15px;
                margin: 15px 0;
                font-weight: bold;
                color: #8b4561;
                page-break-inside: avoid;
            }

            .print-content .ingredient-composition {
                margin-left: 20px;
                font-size: 11px;
                color: #555;
                font-style: italic;
            }

            .print-content .ingredient-composition strong {
                color: #000;
                font-weight: 700;
            }

            .print-content .servings-box {
                background: var(--color-bg-light);
                border: 2px solid var(--color-teal);
                padding: 10px;
                margin: 15px 0;
                border-radius: 6px;
            }

            .print-content ul {
                margin-left: 25px;
                line-height: 1.8;
            }

            .print-content .instructions {
                margin-top: 20px;
                line-height: 1.8;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2em;
            }

            .tabs {
                flex-direction: column;
            }

            .export-import-buttons {
                grid-template-columns: 1fr;
            }

            .recipe-actions {
                flex-direction: column;
            }

            .recipe-actions button {
                width: 100%;
            }

            .nutrition-grid {
                grid-template-columns: 1fr;
            }
        }

        .settings-section {
            background: var(--color-bg-light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .logo-upload-area {
            border: 2px dashed var(--color-border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logo-upload-area:hover {
            border-color: var(--color-teal);
            background: rgba(129, 201, 201, 0.05);
        }

        .logo-preview {
            max-width: 200px;
            max-height: 120px;
            margin: 10px auto;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container" id="logoContainer">
                <h1 id="appTitle">BakeBase Recipe Manager</h1>
                <p class="subtitle">Professional Recipe & Allergen Management</p>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('recipes')">Recipes</button>
            <button class="tab-button" onclick="switchTab('ingredients')">Master Ingredients</button>
            <button class="tab-button" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- RECIPES TAB -->
        <div id="recipesTab" class="tab-content active">
            <div class="card" style="margin-bottom: 20px;">
                <h2>Search Recipes</h2>
                <div class="search-box">
                    <span class="search-icon">⌕</span>
                    <input type="text" id="searchRecipes" placeholder="Search by name, ingredient, or category..." oninput="filterRecipes()">
                </div>
                <div class="category-pills" id="categoryFilter">
                    <div class="category-pill active" onclick="filterByCategory('all')">All</div>
                    <div class="category-pill" onclick="filterByCategory('Cakes')">Cakes</div>
                    <div class="category-pill" onclick="filterByCategory('Cookies')">Cookies</div>
                    <div class="category-pill" onclick="filterByCategory('Biscuits')">Biscuits</div>
                    <div class="category-pill" onclick="filterByCategory('Traybakes')">Traybakes</div>
                    <div class="category-pill" onclick="filterByCategory('Breads')">Breads</div>
                    <div class="category-pill" onclick="filterByCategory('Pastries')">Pastries</div>
                    <div class="category-pill" onclick="filterByCategory('Desserts')">Desserts</div>
                    <div class="category-pill" onclick="filterByCategory('Other')">Other</div>
                </div>
            </div>

            <div class="main-content">
                <div class="card">
                    <h2>Add New Recipe</h2>
                    <form id="recipeForm">
                        <div class="form-group">
                            <label>Recipe Name</label>
                            <input type="text" id="recipeName" required>
                        </div>

                        <div class="form-group">
                            <label>Category</label>
                            <select id="recipeCategory" required>
                                <option value="">Select category...</option>
                                <option value="Cakes">Cakes</option>
                                <option value="Cookies">Cookies</option>
                                <option value="Biscuits">Biscuits</option>
                                <option value="Traybakes">Traybakes</option>
                                <option value="Breads">Breads</option>
                                <option value="Pastries">Pastries</option>
                                <option value="Desserts">Desserts</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="recipeDescription" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Source (optional)</label>
                            <input type="text" id="recipeSource" placeholder="e.g., BBC Good Food, Great British Bake Off book, page 45">
                        </div>

                        <div class="form-group">
                            <label>Instructions</label>
                            <textarea id="recipeInstructions" rows="4"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Servings/Yield</label>
                            <input type="text" id="recipeServings" placeholder="e.g., 12 cookies or 8 servings">
                        </div>

                        <div class="form-group">
                            <label>Tin Size (optional)</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <select id="tinShape" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                                        <option value="">Shape...</option>
                                        <option value="Round">Round</option>
                                        <option value="Square">Square</option>
                                        <option value="Rectangular">Rectangular</option>
                                        <option value="Loaf">Loaf</option>
                                        <option value="Bundt">Bundt</option>
                                        <option value="Springform">Springform</option>
                                        <option value="Traybake">Traybake</option>
                                        <option value="Muffin Tray">Muffin Tray</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <input type="text" id="tinSize" placeholder="e.g., 20cm, 8 inch, 9x13" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                                </div>
                            </div>
                            <input type="text" id="tinNotes" placeholder="Additional tin notes (e.g., greased and lined)" style="width: 100%; margin-top: 8px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                        </div>

                        <button type="submit" class="btn">Save Recipe</button>
                    </form>
                </div>

                <div class="card">
                    <h2>Ingredients</h2>
                    
                    <div class="form-group">
                        <label>Add Ingredient</label>
                        <div class="ingredient-input">
                            <select id="ingredientSelect">
                                <option value="">Select from master list...</option>
                            </select>
                            <input type="text" id="ingredientAmount" placeholder="Amount">
                            <button type="button" onclick="addIngredientToRecipe()">Add</button>
                        </div>
                    </div>

                    <ul class="ingredient-list" id="recipeIngredientList"></ul>

                    <div class="form-group">
                        <label>Detected Allergens in Recipe</label>
                        <div id="detectedAllergens" style="min-height: 40px; padding: 10px; background: var(--color-bg-light); border-radius: 6px; border: 1px solid var(--color-border);">
                            <em style="color: #999;">Add ingredients to see allergens</em>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>My Recipes</h2>
                
                <!-- Backup Warning Banner -->
                <div id="backupWarning" style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <p style="margin: 0; font-weight: 600; color: #856404; margin-bottom: 8px;">⚠️ Important: Backup Your Data</p>
                        <p style="margin: 0; font-size: 14px; color: #856404; line-height: 1.6;">Your recipes are stored in your browser. If you clear your browsing history or use a different browser, your data will be lost. Export regular backups using the button below!</p>
                    </div>
                    <button onclick="dismissBackupWarning()" style="background: transparent; border: none; color: #856404; font-size: 20px; cursor: pointer; padding: 0 0 0 15px; line-height: 1;">×</button>
                </div>

                <!-- Selection Info & Quick Actions -->
                <div style="background: var(--color-bg-light); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--color-teal);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <p style="margin: 0; font-weight: 600; color: var(--color-accent);">
                            <span id="selectedCount">0</span> recipe(s) selected
                        </p>
                        <div style="display: flex; gap: 8px;">
                            <button id="btnSelectMode" onclick="toggleSelectMode()" style="background: var(--color-teal); color: white; border: none; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; font-family: inherit;">☑ Select Mode</button>
                            <button onclick="selectAllRecipes()" style="background: white; border: 2px solid var(--color-teal); color: var(--color-accent); padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; font-family: inherit;">Select All</button>
                            <button onclick="deselectAllRecipes()" style="background: white; border: 2px solid var(--color-teal); color: var(--color-accent); padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; font-family: inherit;">Deselect All</button>
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button id="btnView" onclick="viewSelectedRecipes()" disabled style="background: #42a5f5; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; font-family: inherit;">View <span id="viewCount"></span></button>
                        <button id="btnEdit" onclick="editSelectedRecipe()" disabled style="background: #66bb6a; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; font-family: inherit;">Edit</button>
                        <button id="btnDuplicate" onclick="duplicateSelectedRecipe()" disabled style="background: #ffa726; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; font-family: inherit;">Duplicate</button>
                        <button id="btnPrintFull" onclick="printSelectedFull()" disabled style="background: var(--color-teal); color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; font-family: inherit;">Print Full <span id="printFullCount"></span></button>
                        <button id="btnPrintList" onclick="printSelectedList()" disabled style="background: var(--color-purple); color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; font-family: inherit;">Print List <span id="printListCount"></span></button>
                        <button id="btnScale" onclick="scaleSelectedRecipe()" disabled style="background: #ffa726; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; font-family: inherit;">Scale</button>
                        <button id="btnBatch" onclick="batchSelectedRecipe()" disabled style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; font-family: inherit;">Batch</button>
                        <button id="btnDelete" onclick="deleteSelectedRecipes()" disabled style="background: var(--color-pink); color: #8b4561; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; font-family: inherit;">Delete <span id="deleteCount"></span></button>
                    </div>
                </div>

                <div class="recipes-grid" id="recipesGrid"></div>
                
                <!-- Allergen Table Export Section -->
                <div class="export-import-section" style="margin-bottom: 20px;">
                    <h3>Allergen Reference Table</h3>
                    <p style="color: var(--color-text-light); margin-bottom: 15px; font-size: 14px;">Export a table showing all recipes and their allergens for quick reference.</p>
                    <div class="export-import-buttons">
                        <button class="btn-export" onclick="exportAllergenTable('excel')">Export to Excel</button>
                        <button class="btn-export" onclick="exportAllergenTable('pdf')">Export to PDF</button>
                    </div>
                </div>

                <!-- Export/Import Section -->
                <div class="export-import-section">
                    <h3>Backup & Transfer</h3>
                    <p style="color: var(--color-text-light); margin-bottom: 15px; font-size: 14px;">Export your data to save a backup or transfer to another device/browser. Import to restore your data.</p>
                    <div class="export-import-buttons">
                        <button class="btn-export" onclick="exportData()">Export All Data</button>
                        <button class="btn-import" onclick="document.getElementById('importFile').click()">Import Data</button>
                    </div>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                </div>
            </div>
        </div>

        <!-- MASTER INGREDIENTS TAB -->
        <div id="ingredientsTab" class="tab-content">
            <div class="card">
                <h2>Master Ingredient List</h2>
                <p style="color: var(--color-text-light); margin-bottom: 20px;">Create a library of ingredients with their compositions and allergens. When you update an ingredient here, it updates in all recipes automatically.</p>
                
                <div class="form-group">
                    <label>Ingredient Name</label>
                    <input type="text" id="masterIngredientName" placeholder="e.g., Nutella">
                </div>

                <div class="form-group">
                    <label>Composition (optional)</label>
                    <textarea id="masterIngredientComposition" rows="3" placeholder="e.g., sugar, palm oil, hazelnuts (13%), skimmed milk powder (8.7%), fat-reduced cocoa (7.4%), emulsifier (lecithin/soya), and vanillin"></textarea>
                </div>

                <div class="form-group">
                    <label>Allergens (UK 14)</label>
                    <div class="allergen-checkboxes" id="masterAllergenCheckboxes">
                        <label><input type="checkbox" value="Celery"> Celery</label>
                        <label><input type="checkbox" value="Cereals containing gluten"> Cereals containing gluten</label>
                        <label><input type="checkbox" value="Crustaceans"> Crustaceans</label>
                        <label><input type="checkbox" value="Eggs"> Eggs</label>
                        <label><input type="checkbox" value="Fish"> Fish</label>
                        <label><input type="checkbox" value="Lupin"> Lupin</label>
                        <label><input type="checkbox" value="Milk"> Milk</label>
                        <label><input type="checkbox" value="Molluscs"> Molluscs</label>
                        <label><input type="checkbox" value="Mustard"> Mustard</label>
                        <label><input type="checkbox" value="Peanuts"> Peanuts</label>
                        <label><input type="checkbox" value="Sesame"> Sesame</label>
                        <label><input type="checkbox" value="Soybeans"> Soybeans</label>
                        <label><input type="checkbox" value="Sulphur dioxide/Sulphites"> Sulphur dioxide/Sulphites</label>
                        <label><input type="checkbox" value="Tree nuts"> Tree nuts</label>
                    </div>
                </div>

                <button class="btn" onclick="saveMasterIngredient()">Add to Master List</button>

                <div style="margin-top: 30px;">
                    <h3 style="color: var(--color-accent); margin-bottom: 15px; font-family: Georgia, 'Times New Roman', serif;">Saved Ingredients</h3>
                    <div id="masterIngredientsList"></div>
                </div>

                <!-- Export/Import Section for Ingredients -->
                <div class="export-import-section">
                    <h3>Backup & Transfer</h3>
                    <p style="color: var(--color-text-light); margin-bottom: 15px; font-size: 14px;">Export your data to save a backup or transfer to another device/browser. Import to restore your data.</p>
                    <div class="export-import-buttons">
                        <button class="btn-export" onclick="exportData()">Export All Data</button>
                        <button class="btn-import" onclick="document.getElementById('importFile').click()">Import Data</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settingsTab" class="tab-content">
            <div class="card">
                <h2>Settings & Customization</h2>
                
                <div class="settings-section">
                    <h3 style="color: var(--color-accent); margin-bottom: 15px; font-family: Georgia, 'Times New Roman', serif;">Custom Logo</h3>
                    <p style="color: var(--color-text-light); margin-bottom: 15px; font-size: 14px;">Upload your business logo to personalize the app</p>
                    <div class="logo-upload-area" onclick="document.getElementById('logoUpload').click()">
                        <div id="logoPreviewContainer">
                            <p>Click to upload logo (PNG, JPG, SVG)</p>
                            <p style="font-size: 12px; color: var(--color-text-light); margin-top: 5px;">Max 200x120px</p>
                        </div>
                    </div>
                    <input type="file" id="logoUpload" accept="image/*" style="display: none;" onchange="uploadLogo(event)">
                    <button onclick="removeLogo()" style="margin-top: 10px; padding: 8px 16px; background: var(--color-pink); color: #8b4561; border: none; border-radius: 6px; cursor: pointer;">Remove Logo</button>
                </div>

                <div class="settings-section">
                    <h3 style="color: var(--color-accent); margin-bottom: 15px; font-family: Georgia, 'Times New Roman', serif;">Business Name</h3>
                    <input type="text" id="businessName" placeholder="Enter your business name" value="BakeBase">
                    <button onclick="updateBusinessName()" style="margin-top: 10px;" class="btn">Update Name</button>
                </div>


                <div class="settings-section">
                    <h3 style="color: var(--color-accent); margin-bottom: 15px; font-family: Georgia, 'Times New Roman', serif;">Color Theme</h3>
                    <p style="color: var(--color-text-light); margin-bottom: 15px; font-size: 14px;">Choose a color scheme for your app</p>
                    <div class="theme-options">
                        <div class="theme-option active" style="background: linear-gradient(135deg, #81c9c9, #b8a8d4, #f5c6d6);" onclick="setTheme('bakebase')">
                            <strong>BakeBase</strong>
                        </div>
                        <div class="theme-option" style="background: linear-gradient(135deg, #a8e6cf, #dcedc1);" onclick="setTheme('mint')">
                            <strong>Mint Fresh</strong>
                        </div>
                        <div class="theme-option" style="background: linear-gradient(135deg, #ffd1dc, #ffb3d9);" onclick="setTheme('rose')">
                            <strong>Rose</strong>
                        </div>
                        <div class="theme-option" style="background: linear-gradient(135deg, #a3c4f3, #8eecf5);" onclick="setTheme('ocean')">
                            <strong>Ocean</strong>
                        </div>
                        <div class="theme-option" style="background: linear-gradient(135deg, #f4a261, #e76f51);" onclick="setTheme('autumn')">
                            <strong>Autumn</strong>
                        </div>
                    </div>
                </div>

                <div class="export-import-section">
                    <h3>License Information</h3>
                    <p style="color: var(--color-text-light); margin-bottom: 10px; font-size: 14px; line-height: 1.6;">
                        This software is licensed for personal and commercial use. You may use this for your bakery, food business, or personal recipe management. 
                        <br><br>
                        <strong>⚠️ Important Disclaimer:</strong> While this tool helps track allergens, always verify ingredient compositions and consult with healthcare professionals for allergen information. The software provider is not liable for allergen-related incidents.
                    <br><br>
                        <strong>© 2026 BakeBase. All rights reserved.</strong><br>
                        <span style="font-size: 12px; opacity: 0.8;">This software and its contents are protected by copyright law. Unauthorized reproduction or distribution is prohibited.</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden print content container -->
    <div id="printContent" class="print-content"></div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>Edit Ingredient</h3>
            <div class="form-group">
                <label>Ingredient Name</label>
                <input type="text" id="editIngredientName">
            </div>
            <div class="form-group">
                <label>Composition</label>
                <textarea id="editIngredientComposition" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Allergens (UK 14)</label>
                <div class="allergen-checkboxes" id="editAllergenCheckboxes">
                    <label><input type="checkbox" value="Celery"> Celery</label>
                    <label><input type="checkbox" value="Cereals containing gluten"> Cereals containing gluten</label>
                    <label><input type="checkbox" value="Crustaceans"> Crustaceans</label>
                    <label><input type="checkbox" value="Eggs"> Eggs</label>
                    <label><input type="checkbox" value="Fish"> Fish</label>
                    <label><input type="checkbox" value="Lupin"> Lupin</label>
                    <label><input type="checkbox" value="Milk"> Milk</label>
                    <label><input type="checkbox" value="Molluscs"> Molluscs</label>
                    <label><input type="checkbox" value="Mustard"> Mustard</label>
                    <label><input type="checkbox" value="Peanuts"> Peanuts</label>
                    <label><input type="checkbox" value="Sesame"> Sesame</label>
                    <label><input type="checkbox" value="Soybeans"> Soybeans</label>
                    <label><input type="checkbox" value="Sulphur dioxide/Sulphites"> Sulphur dioxide/Sulphites</label>
                    <label><input type="checkbox" value="Tree nuts"> Tree nuts</label>
                </div>
            </div>
            <div class="modal-actions">
                <button style="background: var(--color-teal); color: white;" onclick="saveEditedIngredient()">Save Changes</button>
                <button style="background: #e0e0e0; color: var(--color-text);" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scale Recipe Modal -->
    <div id="scaleModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Scale Recipe</h3>
            <p style="color: var(--color-text-light); font-size: 14px; margin-bottom: 20px;">
                Current yield: <strong><span id="currentYield"></span></strong>
            </p>

            <!-- Mode tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="scaleTabMultiplier" onclick="setScaleTab('multiplier')" style="flex:1; padding: 10px; border: 2px solid var(--color-teal); background: var(--color-teal); color: white; border-radius: 8px; font-weight: 600; cursor: pointer; font-family: inherit;">✕ Multiply</button>
                <button id="scaleTabYield" onclick="setScaleTab('yield')" style="flex:1; padding: 10px; border: 2px solid var(--color-teal); background: white; color: var(--color-accent); border-radius: 8px; font-weight: 600; cursor: pointer; font-family: inherit;">⚖ By Yield</button>
            </div>

            <!-- Multiplier mode -->
            <div id="scaleModeMultiplier">
                <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                    <button onclick="setMultiplier(2)" class="multiplier-btn" id="mult2">× 2</button>
                    <button onclick="setMultiplier(3)" class="multiplier-btn" id="mult3">× 3</button>
                    <button onclick="setMultiplier(4)" class="multiplier-btn" id="mult4">× 4</button>
                    <button onclick="setMultiplier(5)" class="multiplier-btn" id="mult5">× 5</button>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="font-size: 14px; color: var(--color-text-light); white-space: nowrap;">Custom ×</label>
                    <input type="number" id="customMultiplier" min="0.1" step="0.1" placeholder="e.g. 1.5"
                        style="flex:1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;"
                        oninput="setMultiplier(parseFloat(this.value))">
                </div>
            </div>

            <!-- Yield mode -->
            <div id="scaleModeYield" style="display:none;">
                <div class="form-group">
                    <label>New Yield / Portions</label>
                    <input type="number" id="newYield" min="1" placeholder="e.g. 24 cookies or 12 servings"
                        style="width:100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                </div>
            </div>

            <button onclick="applyScaling()" style="width:100%; margin-top: 16px; padding: 12px; background: var(--color-teal); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit;">Calculate</button>

            <!-- Results -->
            <div id="scaledIngredients" style="margin-top: 20px;"></div>

            <!-- Save section — shown after calculating -->
            <div id="scaleSaveSection" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--color-border);">
                <h4 style="color: var(--color-accent); margin-bottom: 16px;">Save as New Recipe</h4>
                <div class="form-group">
                    <label>Recipe Name</label>
                    <input type="text" id="scaledRecipeName" style="width:100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                </div>
                <div class="form-group">
                    <label>New Yield / Servings</label>
                    <input type="text" id="scaledRecipeServings" style="width:100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                </div>
                <div class="form-group">
                    <label>Tin Size (optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <select id="scaledTinShape" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                            <option value="">Shape...</option>
                            <option value="Round">Round</option>
                            <option value="Square">Square</option>
                            <option value="Rectangular">Rectangular</option>
                            <option value="Loaf">Loaf</option>
                            <option value="Bundt">Bundt</option>
                            <option value="Springform">Springform</option>
                            <option value="Traybake">Traybake</option>
                            <option value="Muffin Tray">Muffin Tray</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="text" id="scaledTinSize" placeholder="e.g. 20cm, 9x13" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>
                    <input type="text" id="scaledTinNotes" placeholder="e.g. greased and lined" style="width:100%; margin-top: 8px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                </div>
                <div class="modal-actions">
                    <button style="background: #4caf50; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit;" onclick="saveScaledRecipe()">Save Recipe</button>
                    <button style="background: #e0e0e0; color: var(--color-text); padding: 12px 24px; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; font-family: inherit;" onclick="closeScaleModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Recipe Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; padding-bottom: 15px; border-bottom: 2px solid var(--color-border); z-index: 10;">
                <h3 id="viewRecipeName" style="margin: 0; color: var(--color-accent);"></h3>
                <button onclick="closeViewModal()" style="background: #e0e0e0; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 20px; line-height: 1; color: #666;">×</button>
            </div>
            
            <div id="viewRecipeContent"></div>
        </div>
    </div>

    <!-- Batch Conversion Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; padding-bottom: 15px; border-bottom: 2px solid var(--color-border); z-index: 10;">
                <h3 style="margin: 0; color: var(--color-accent);">Edit Recipe</h3>
                <button onclick="closeEditModal()" style="background: #e0e0e0; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 20px; line-height: 1; color: #666;">×</button>
            </div>

            <div class="form-group">
                <label>Recipe Name</label>
                <input type="text" id="editRecipeName" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
            </div>

            <div class="form-group">
                <label>Category</label>
                <select id="editRecipeCategory" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    <option value="Cakes">Cakes</option>
                    <option value="Cookies">Cookies</option>
                    <option value="Biscuits">Biscuits</option>
                    <option value="Traybakes">Traybakes</option>
                    <option value="Breads">Breads</option>
                    <option value="Pastries">Pastries</option>
                    <option value="Desserts">Desserts</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="editRecipeDescription" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
            </div>

            <div class="form-group">
                <label>Source</label>
                <input type="text" id="editRecipeSource" placeholder="e.g., BBC Good Food" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
            </div>

            <div class="form-group">
                <label>Instructions</label>
                <textarea id="editRecipeInstructions" rows="4" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
            </div>

            <div class="form-group">
                <label>Servings/Yield</label>
                <input type="text" id="editRecipeServings" placeholder="e.g., 12 cookies" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
            </div>

            <div class="form-group">
                <label>Tin Size</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <select id="editTinShape" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                        <option value="">Shape...</option>
                        <option value="Round">Round</option>
                        <option value="Square">Square</option>
                        <option value="Rectangular">Rectangular</option>
                        <option value="Loaf">Loaf</option>
                        <option value="Bundt">Bundt</option>
                        <option value="Springform">Springform</option>
                        <option value="Traybake">Traybake</option>
                        <option value="Muffin Tray">Muffin Tray</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="editTinSize" placeholder="e.g., 20cm" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
                </div>
                <input type="text" id="editTinNotes" placeholder="e.g., greased and lined" style="width: 100%; margin-top: 8px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit;">
            </div>

            <div class="form-group">
                <label>Ingredients</label>
                <div id="editIngredientsList" style="margin-top: 10px;"></div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveEditedRecipe()" style="flex: 1; background: #66bb6a; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit;">Save Changes</button>
                <button onclick="closeEditModal()" style="background: #e0e0e0; color: var(--color-text); border: none; padding: 12px 24px; border-radius: 8px; font-size: 15px; cursor: pointer; font-family: inherit;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Batch Conversion Modal -->
    <div id="batchModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 style="color: #667eea;">Batch Calculator</h3>
            <p style="color: var(--color-text-light); margin-bottom: 20px;">
                Calculate ingredients needed for multiple batches of <strong id="batchRecipeName"></strong>
            </p>
            
            <div class="form-group">
                <label>Original Yield: <span id="batchOriginalYield" style="color: var(--color-accent); font-weight: 600;"></span></label>
                <label style="margin-top: 15px;">Number of Batches:</label>
                <input type="number" id="numberOfBatches" min="1" step="1" placeholder="e.g., 5" value="5" style="font-size: 18px; font-weight: 600;">
                <p style="font-size: 12px; color: var(--color-text-light); margin-top: 5px;">
                    💡 Tip: Consider your mixing capacity and storage space
                </p>
            </div>
            
            <div id="batchResults" style="margin-top: 20px; max-height: 400px; overflow-y: auto;"></div>
            
            <div class="modal-actions">
                <button style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;" onclick="calculateBatch()">Calculate Batches</button>
                <button style="background: #e0e0e0; color: var(--color-text);" onclick="closeBatchModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="print-content" id="printContent"></div>

    <script>
        // Data storage
        let recipes = JSON.parse(localStorage.getItem('recipes')) || [];
        let masterIngredients = JSON.parse(localStorage.getItem('masterIngredients')) || [];
        let currentRecipeIngredients = [];
        let editingIngredientId = null;
        let currentFilter = 'all';
        let selectMode = false;
        let selectedRecipeIds = new Set();
        let scalingRecipe = null;
        let scaledIngredientsList = [];
        let currentScaleFactor = 1;
        let settings = JSON.parse(localStorage.getItem('appSettings')) || {
            businessName: 'BakeBase',
            logo: null,
            theme: 'bakebase'
        };


        // Batch Conversion Functions
        function openBatchModal(recipeId) {
            currentRecipeId = recipeId;
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            document.getElementById('batchRecipeName').textContent = recipe.name;
            document.getElementById('batchOriginalYield').textContent = recipe.servings || 'Not specified';
            document.getElementById('batchModal').classList.add('active');
        }

        function closeBatchModal() {
            document.getElementById('batchModal').classList.remove('active');
            document.getElementById('batchResults').innerHTML = '';
        }

        function calculateBatch() {
            const numberOfBatches = parseFloat(document.getElementById('numberOfBatches').value);
            
            if (!numberOfBatches || numberOfBatches <= 0) {
                alert('Please enter a valid number of batches');
                return;
            }

            const recipe = recipes.find(r => r.id === currentRecipeId);
            if (!recipe) return;

            let resultsHTML = `
                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #2b7a8e;">${numberOfBatches} Batch${numberOfBatches > 1 ? 'es' : ''} of ${recipe.name}</h3>
                    <p><strong>Original Yield:</strong> ${recipe.servings || 'Not specified'}</p>
                    <p><strong>Total Yield:</strong> ${numberOfBatches} Ã— ${recipe.servings || '?'} = ${numberOfBatches * (parseInt(recipe.servings) || 0)} servings</p>
                </div>

                <h3>Ingredients Needed:</h3>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr style="background: #e0f2f7; border-bottom: 2px solid #2b7a8e;">
                            <th style="padding: 10px; text-align: left;">Ingredient</th>
                            <th style="padding: 10px; text-align: right;">Per Batch</th>
                            <th style="padding: 10px; text-align: right;">Total (${numberOfBatches}x)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            recipe.ingredients.forEach(ing => {
                const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                if (masterIng) {
                    const parsed = parseAmount(ing.amount);
                    const totalValue = parsed.value * numberOfBatches;
                    const totalAmount = parsed.unit ? `${totalValue.toFixed(2)} ${parsed.unit}` : totalValue.toFixed(2);
                    
                    resultsHTML += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px;"><strong>${masterIng.name}</strong></td>
                            <td style="padding: 10px; text-align: right;">${ing.amount}</td>
                            <td style="padding: 10px; text-align: right; color: #2b7a8e; font-weight: 600;">${totalAmount}</td>
                        </tr>
                    `;
                }
            });

            resultsHTML += `
                    </tbody>
                </table>

                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <strong>Tip:</strong> Consider packaging, mixing capacity, and storage space when making multiple batches!
                </div>
            `;

            document.getElementById('batchResults').innerHTML = resultsHTML;
        }

        // Initialize app
        function initializeApp() {
            applySettings();
            displayMasterIngredients();
            updateIngredientSelect();
            displayRecipes();
        }

        function applySettings() {
            document.getElementById('businessName').value = settings.businessName;
            updateBusinessNameDisplay();
            if (settings.logo) {
                displayLogo();
            }
            setTheme(settings.theme, false);
        }

        function updateBusinessName() {
            const name = document.getElementById('businessName').value.trim();
            if (name) {
                settings.businessName = name;
                localStorage.setItem('appSettings', JSON.stringify(settings));
                updateBusinessNameDisplay();
                alert('Business name updated!');
            }
        }

        function updateBusinessNameDisplay() {
            const titleElement = document.getElementById('appTitle');
            if (settings.logo) {
                titleElement.textContent = settings.businessName;
            } else {
                titleElement.textContent = settings.businessName + ' Recipe Manager';
            }
        }

        function uploadLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    settings.logo = e.target.result;
                    localStorage.setItem('appSettings', JSON.stringify(settings));
                    displayLogo();
                    alert('Logo uploaded successfully!');
                };
                reader.readAsDataURL(file);
            }
        }

        function displayLogo() {
            const container = document.getElementById('logoContainer');
            const titleElement = document.getElementById('appTitle');
            
            if (settings.logo) {
                const img = document.createElement('img');
                img.src = settings.logo;
                img.className = 'custom-logo';
                img.alt = settings.businessName + ' Logo';
                
                const existingLogo = container.querySelector('.custom-logo');
                if (existingLogo) {
                    existingLogo.remove();
                }
                
                container.insertBefore(img, titleElement);
                titleElement.textContent = settings.businessName;
                
                // Update preview in settings
                const preview = document.getElementById('logoPreviewContainer');
                preview.innerHTML = `<img src="${settings.logo}" class="logo-preview" alt="Logo Preview">
                    <p style="font-size: 12px; margin-top: 10px;">Click to change logo</p>`;
            }
        }

        function removeLogo() {
            if (confirm('Remove your custom logo?')) {
                settings.logo = null;
                localStorage.setItem('appSettings', JSON.stringify(settings));
                const existingLogo = document.querySelector('.custom-logo');
                if (existingLogo) {
                    existingLogo.remove();
                }
                updateBusinessNameDisplay();
                document.getElementById('logoPreviewContainer').innerHTML = `
                    <p>Click to upload logo (PNG, JPG, SVG)</p>
                    <p style="font-size: 12px; color: var(--color-text-light); margin-top: 5px;">Max 200x120px</p>
                `;
                alert('Logo removed!');
            }
        }

        const themes = {
            bakebase: {
                teal: '#81c9c9',
                tealDark: '#6bb3b3',
                purple: '#b8a8d4',
                purpleDark: '#a395c4',
                pink: '#f5c6d6',
                pinkDark: '#eab3c9',
                accent: '#2b7a8e'
            },
            mint: {
                teal: '#a8e6cf',
                tealDark: '#8dd3b0',
                purple: '#dcedc1',
                purpleDark: '#c9e0a9',
                pink: '#c1ffc1',
                pinkDark: '#a8e6a8',
                accent: '#2d7a4f'
            },
            rose: {
                teal: '#ffd1dc',
                tealDark: '#ffb3c6',
                purple: '#ffb3d9',
                purpleDark: '#ff99cc',
                pink: '#ffc8dd',
                pinkDark: '#ffadc7',
                accent: '#c41e3a'
            },
            ocean: {
                teal: '#a3c4f3',
                tealDark: '#8aaee0',
                purple: '#8eecf5',
                purpleDark: '#6dd5df',
                pink: '#98d8e8',
                pinkDark: '#7bc8db',
                accent: '#0466c8'
            },
            autumn: {
                teal: '#f4a261',
                tealDark: '#e38d4b',
                purple: '#e76f51',
                purpleDark: '#d15a3d',
                pink: '#f6bd60',
                pinkDark: '#eca84a',
                accent: '#bc4b2e'
            }
        };

        function setTheme(themeName, save = true) {
            const theme = themes[themeName];
            if (!theme) return;

            const root = document.documentElement;
            root.style.setProperty('--color-teal', theme.teal);
            root.style.setProperty('--color-teal-dark', theme.tealDark);
            root.style.setProperty('--color-purple', theme.purple);
            root.style.setProperty('--color-purple-dark', theme.purpleDark);
            root.style.setProperty('--color-pink', theme.pink);
            root.style.setProperty('--color-pink-dark', theme.pinkDark);
            root.style.setProperty('--color-accent', theme.accent);

            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
            if (event?.target?.closest) {
                event.target.closest('.theme-option')?.classList.add('active');
            }

            if (save) {
                settings.theme = themeName;
                localStorage.setItem('appSettings', JSON.stringify(settings));
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            
            if (tab === 'recipes') {
                document.getElementById('recipesTab').classList.add('active');
            } else if (tab === 'ingredients') {
                document.getElementById('ingredientsTab').classList.add('active');
            } else if (tab === 'settings') {
                document.getElementById('settingsTab').classList.add('active');
            }
            
            event.target.classList.add('active');
        }

        function filterByCategory(category) {
            currentFilter = category;
            document.querySelectorAll('.category-pill').forEach(pill => pill.classList.remove('active'));
            event.target.classList.add('active');
            displayRecipes();
        }

        function filterRecipes() {
            displayRecipes();
        }

        function exportData() {
            const data = {
                recipes: recipes,
                masterIngredients: masterIngredients,
                settings: settings,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${settings.businessName.replace(/\s+/g, '-').toLowerCase()}-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('Data exported successfully! Save this file to import later.');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.recipes && data.masterIngredients) {
                        const confirmed = confirm(
                            'This will replace all your current data. Are you sure?\n\n' +
                            `Importing:\n- ${data.recipes.length} recipes\n- ${data.masterIngredients.length} master ingredients`
                        );
                        
                        if (confirmed) {
                            recipes = data.recipes;
                            masterIngredients = data.masterIngredients;
                            if (data.settings) {
                                settings = data.settings;
                                localStorage.setItem('appSettings', JSON.stringify(settings));
                            }
                            localStorage.setItem('recipes', JSON.stringify(recipes));
                            localStorage.setItem('masterIngredients', JSON.stringify(masterIngredients));
                            
                            initializeApp();
                            alert('Data imported successfully!');
                        }
                    } else {
                        alert('Invalid file format. Please select a valid backup file.');
                    }
                } catch (error) {
                    alert('Error reading file. Please make sure it\'s a valid JSON backup file.');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function saveMasterIngredient() {
            const name = document.getElementById('masterIngredientName').value.trim();
            if (!name) {
                alert('Please enter an ingredient name');
                return;
            }

            const composition = document.getElementById('masterIngredientComposition').value.trim();
            const allergens = Array.from(document.querySelectorAll('#masterAllergenCheckboxes input:checked'))
                .map(cb => cb.value);

            const ingredient = {
                id: Date.now(),
                name: name,
                composition: composition,
                allergens: allergens
            };

            masterIngredients.push(ingredient);
            localStorage.setItem('masterIngredients', JSON.stringify(masterIngredients));

            document.getElementById('masterIngredientName').value = '';
            document.getElementById('masterIngredientComposition').value = '';
            document.querySelectorAll('#masterAllergenCheckboxes input').forEach(cb => cb.checked = false);

            displayMasterIngredients();
            updateIngredientSelect();
            alert('Ingredient added to master list!');
        }

        function displayMasterIngredients() {
            const container = document.getElementById('masterIngredientsList');
            
            if (masterIngredients.length === 0) {
                container.innerHTML = '<p style="color: #999; padding: 20px; text-align: center;">No ingredients yet. Add your first ingredient above!</p>';
                return;
            }

            container.innerHTML = masterIngredients.map(ing => `
                <div class="master-ingredient-card">
                    <h4>${ing.name}</h4>
                    ${ing.composition ? `<div class="composition">${ing.composition}</div>` : ''}
                    ${ing.allergens.length > 0 ? `
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #8b4561;">Contains:</strong> ${ing.allergens.join(', ')}
                        </div>
                    ` : ''}
                    <div class="actions">
                        <button style="background: var(--color-teal); color: white;" onclick="editMasterIngredient(${ing.id})">Edit</button>
                        <button style="background: var(--color-pink); color: #8b4561;" onclick="deleteMasterIngredient(${ing.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function editMasterIngredient(id) {
            const ingredient = masterIngredients.find(i => i.id === id);
            if (!ingredient) return;

            editingIngredientId = id;
            document.getElementById('editIngredientName').value = ingredient.name;
            document.getElementById('editIngredientComposition').value = ingredient.composition || '';
            
            document.querySelectorAll('#editAllergenCheckboxes input').forEach(cb => {
                cb.checked = ingredient.allergens.includes(cb.value);
            });

            document.getElementById('editModal').classList.add('active');
        }

        function saveEditedIngredient() {
            const ingredient = masterIngredients.find(i => i.id === editingIngredientId);
            if (!ingredient) return;

            ingredient.name = document.getElementById('editIngredientName').value.trim();
            ingredient.composition = document.getElementById('editIngredientComposition').value.trim();
            ingredient.allergens = Array.from(document.querySelectorAll('#editAllergenCheckboxes input:checked'))
                .map(cb => cb.value);

            localStorage.setItem('masterIngredients', JSON.stringify(masterIngredients));
            
            displayMasterIngredients();
            updateIngredientSelect();
            displayRecipes();
            closeEditModal();
            
            alert('Ingredient updated! All recipes using this ingredient have been updated.');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingIngredientId = null;
        }

        function deleteMasterIngredient(id) {
            if (!confirm('Delete this ingredient? It will be removed from all recipes.')) return;

            masterIngredients = masterIngredients.filter(i => i.id !== id);
            localStorage.setItem('masterIngredients', JSON.stringify(masterIngredients));
            
            recipes.forEach(recipe => {
                recipe.ingredients = recipe.ingredients.filter(ing => ing.masterIngredientId !== id);
            });
            localStorage.setItem('recipes', JSON.stringify(recipes));

            displayMasterIngredients();
            updateIngredientSelect();
            displayRecipes();
        }

        function updateIngredientSelect() {
            const select = document.getElementById('ingredientSelect');
            const sorted = [...masterIngredients].sort((a, b) => a.name.localeCompare(b.name));
            select.innerHTML = '<option value="">Select from master list...</option>' +
                sorted.map(ing => 
                    `<option value="${ing.id}">${ing.name}</option>`
                ).join('');
        }

        function addIngredientToRecipe() {
            const ingredientId = document.getElementById('ingredientSelect').value;
            const amount = document.getElementById('ingredientAmount').value.trim();

            if (!ingredientId || !amount) {
                alert('Please select an ingredient and enter an amount');
                return;
            }

            const masterIng = masterIngredients.find(i => i.id == ingredientId);
            if (!masterIng) return;

            currentRecipeIngredients.push({
                masterIngredientId: masterIng.id,
                amount: amount
            });

            updateRecipeIngredientList();
            updateDetectedAllergens();
            
            document.getElementById('ingredientSelect').value = '';
            document.getElementById('ingredientAmount').value = '';
        }

        function removeIngredientFromRecipe(index) {
            currentRecipeIngredients.splice(index, 1);
            updateRecipeIngredientList();
            updateDetectedAllergens();
        }

        function updateRecipeIngredientList() {
            const list = document.getElementById('recipeIngredientList');
            list.innerHTML = currentRecipeIngredients.map((ing, index) => {
                const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                if (!masterIng) return '';
                
                return `
                    <li class="ingredient-item">
                        <div>
                            <strong>${ing.amount} ${masterIng.name}</strong>
                            ${masterIng.composition ? `<div class="ingredient-details">${masterIng.composition}</div>` : ''}
                        </div>
                        <button onclick="removeIngredientFromRecipe(${index})">Remove</button>
                    </li>
                `;
            }).join('');
        }

        function updateDetectedAllergens() {
            const allergenSet = new Set();
            
            currentRecipeIngredients.forEach(ing => {
                const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                if (masterIng) {
                    masterIng.allergens.forEach(a => allergenSet.add(a));
                }
            });

            const container = document.getElementById('detectedAllergens');
            if (allergenSet.size === 0) {
                container.innerHTML = '<em style="color: #999;">No allergens detected</em>';
            } else {
                container.innerHTML = Array.from(allergenSet).map(a => 
                    `<span class="allergen-badge">${a}</span>`
                ).join(' ');
            }
        }

        document.getElementById('recipeForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (currentRecipeIngredients.length === 0) {
                alert('Please add at least one ingredient');
                return;
            }

            const recipe = {
                id: Date.now(),
                name: document.getElementById('recipeName').value,
                category: document.getElementById('recipeCategory').value,
                description: document.getElementById('recipeDescription').value,
                source: document.getElementById('recipeSource').value,
                instructions: document.getElementById('recipeInstructions').value,
                servings: document.getElementById('recipeServings').value,
                tinShape: document.getElementById('tinShape').value,
                tinSize: document.getElementById('tinSize').value,
                tinNotes: document.getElementById('tinNotes').value,
                ingredients: [...currentRecipeIngredients],
                createdDate: new Date().toISOString()
            };

            recipes.push(recipe);
            localStorage.setItem('recipes', JSON.stringify(recipes));

            document.getElementById('recipeForm').reset();
            currentRecipeIngredients = [];
            updateRecipeIngredientList();
            updateDetectedAllergens();

            displayRecipes();
            alert('Recipe saved successfully!');
        });

        function getRecipeAllergens(recipe) {
            const allergenSet = new Set();
            recipe.ingredients.forEach(ing => {
                const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                if (masterIng) {
                    masterIng.allergens.forEach(a => allergenSet.add(a));
                }
            });
            return Array.from(allergenSet);
        }

        function boldAllergensInText(text, allergens) {
            if (!text || !allergens || allergens.length === 0) return text;
            
            let result = text;
            
            // List of allergen keywords to bold (UK 14 allergens)
            const allergenKeywords = {
                'Celery': ['celery', 'celeriac'],
                'Cereals containing gluten': ['wheat', 'barley', 'rye', 'oats', 'spelt', 'kamut', 'gluten', 'flour'],
                'Crustaceans': ['crab', 'lobster', 'prawns', 'shrimp', 'crayfish', 'langoustine'],
                'Eggs': ['egg', 'eggs', 'albumin'],
                'Fish': ['fish', 'anchovy', 'bass', 'salmon', 'tuna', 'cod', 'haddock', 'plaice', 'mackerel'],
                'Lupin': ['lupin', 'lupine'],
                'Milk': ['milk', 'dairy', 'cream', 'butter', 'cheese', 'yogurt', 'yoghurt', 'whey', 'casein', 'lactose', 'ghee'],
                'Molluscs': ['mussel', 'oyster', 'squid', 'octopus', 'snail', 'clam', 'scallop', 'whelk'],
                'Mustard': ['mustard'],
                'Peanuts': ['peanut', 'peanuts', 'groundnut', 'groundnuts'],
                'Sesame': ['sesame', 'tahini'],
                'Soybeans': ['soy', 'soya', 'soybean', 'soybeans', 'tofu', 'edamame'],
                'Sulphur dioxide/Sulphites': ['sulphite', 'sulphites', 'sulfite', 'sulfites', 'sulphur dioxide', 'sulfur dioxide', 'e220', 'e221', 'e222', 'e223', 'e224', 'e226', 'e227', 'e228'],
                'Tree nuts': ['almond', 'almonds', 'hazelnut', 'hazelnuts', 'walnut', 'walnuts', 'cashew', 'cashews', 'pecan', 'pecans', 'pistachio', 'pistachios', 'macadamia', 'brazil', 'nut', 'nuts']
            };
            
            // Bold allergen keywords that apply to this recipe
            allergens.forEach(allergen => {
                if (allergenKeywords[allergen]) {
                    allergenKeywords[allergen].forEach(keyword => {
                        // Case insensitive replacement, but preserve original case
                        const regex = new RegExp(`\\b(${keyword})(s?)\\b`, 'gi');
                        result = result.replace(regex, '<strong>$1$2</strong>');
                    });
                }
            });
            
            return result;
        }

        function displayRecipes() {
            const grid = document.getElementById('recipesGrid');
            const searchTerm = document.getElementById('searchRecipes').value.toLowerCase();
            
            let filteredRecipes = recipes;
            
            // Filter by category
            if (currentFilter !== 'all') {
                filteredRecipes = filteredRecipes.filter(r => r.category === currentFilter);
            }
            
            // Filter by search term
            if (searchTerm) {
                filteredRecipes = filteredRecipes.filter(recipe => {
                    const nameMatch = recipe.name.toLowerCase().includes(searchTerm);
                    const ingredientMatch = recipe.ingredients.some(ing => {
                        const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                        return masterIng && masterIng.name.toLowerCase().includes(searchTerm);
                    });
                    return nameMatch || ingredientMatch;
                });
            }
            
            if (filteredRecipes.length === 0) {
                grid.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No recipes found. Try adjusting your search or filters.</p>';
                return;
            }

            grid.innerHTML = filteredRecipes.map(recipe => {
                const allergens = getRecipeAllergens(recipe);
                const allergenIcon = allergens.length > 0 ? ' ⚠️' : '';
                const isSelected = selectedRecipeIds.has(recipe.id);
                const clickAction = selectMode ? `toggleRecipeSelection(${recipe.id})` : `viewFullRecipe(${recipe.id})`;
                
                return `
                    <div class="recipe-card ${isSelected ? 'selected' : ''}" onclick="${clickAction}">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                            <input type="checkbox" class="recipe-checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleRecipeSelection(${recipe.id});" style="display: ${selectMode ? 'block' : 'none'};">
                            <h3 style="flex: 1;">${recipe.name}${allergenIcon}</h3>
                            <span class="category-badge" style="font-size: 11px; padding: 3px 10px;">${recipe.category || 'Other'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openScaleModal(recipeId) {
            scalingRecipe = recipes.find(r => r.id === recipeId);
            if (!scalingRecipe) return;

            document.getElementById('currentYield').textContent = scalingRecipe.servings || 'Not specified';
            document.getElementById('newYield').value = '';
            document.getElementById('customMultiplier').value = '';
            document.getElementById('scaledIngredients').innerHTML = '';
            document.getElementById('scaleSaveSection').style.display = 'none';
            scaledIngredientsList = [];
            currentScaleFactor = 1;

            // Reset multiplier button highlights
            document.querySelectorAll('.multiplier-btn').forEach(b => b.classList.remove('active'));
            setScaleTab('multiplier');
            document.getElementById('scaleModal').classList.add('active');
        }

        function closeScaleModal() {
            document.getElementById('scaleModal').classList.remove('active');
            scalingRecipe = null;
            scaledIngredientsList = [];
            currentScaleFactor = 1;
        }

        function setScaleTab(tab) {
            const isMultiplier = tab === 'multiplier';
            document.getElementById('scaleModeMultiplier').style.display = isMultiplier ? 'block' : 'none';
            document.getElementById('scaleModeYield').style.display = isMultiplier ? 'none' : 'block';
            document.getElementById('scaleTabMultiplier').style.background = isMultiplier ? 'var(--color-teal)' : 'white';
            document.getElementById('scaleTabMultiplier').style.color = isMultiplier ? 'white' : 'var(--color-accent)';
            document.getElementById('scaleTabYield').style.background = isMultiplier ? 'white' : 'var(--color-teal)';
            document.getElementById('scaleTabYield').style.color = isMultiplier ? 'var(--color-accent)' : 'white';
            document.getElementById('scaledIngredients').innerHTML = '';
            document.getElementById('scaleSaveSection').style.display = 'none';
        }

        function setMultiplier(val) {
            if (!val || val <= 0) return;
            currentScaleFactor = val;
            // Highlight matching preset button if it matches exactly
            [2,3,4,5].forEach(n => {
                document.getElementById('mult' + n).classList.toggle('active', val === n);
            });
        }

        function applyScaling() {
            let scaleFactor;

            const isMultiplierMode = document.getElementById('scaleModeMultiplier').style.display !== 'none';

            if (isMultiplierMode) {
                scaleFactor = currentScaleFactor || parseFloat(document.getElementById('customMultiplier').value);
                if (!scaleFactor || scaleFactor <= 0) {
                    alert('Please select or enter a multiplier');
                    return;
                }
            } else {
                const newYield = parseFloat(document.getElementById('newYield').value);
                if (!newYield || newYield <= 0) {
                    alert('Please enter a valid yield');
                    return;
                }
                const currentYield = parseFloat(scalingRecipe.servings) || 1;
                scaleFactor = newYield / currentYield;
            }

            scaledIngredientsList = [];
            let scaledHtml = '<h4 style="color: var(--color-accent); margin-bottom: 10px;">Scaled Ingredients:</h4><ul style="margin-left: 20px;">';

            scalingRecipe.ingredients.forEach(ing => {
                const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                if (masterIng) {
                    const amountNum = parseFloat(ing.amount);
                    if (!isNaN(amountNum)) {
                        const scaledAmount = (amountNum * scaleFactor).toFixed(2);
                        const unit = ing.amount.replace(amountNum.toString(), '').trim();
                        scaledHtml += `<li><strong>${scaledAmount} ${unit}</strong> ${masterIng.name}</li>`;
                        scaledIngredientsList.push({ masterIngredientId: masterIng.id, amount: `${scaledAmount} ${unit}` });
                    } else {
                        scaledHtml += `<li>${ing.amount} ${masterIng.name} <em style="color:#999;">(adjust manually)</em></li>`;
                        scaledIngredientsList.push({ masterIngredientId: masterIng.id, amount: ing.amount });
                    }
                }
            });

            scaledHtml += '</ul>';
            document.getElementById('scaledIngredients').innerHTML = scaledHtml;

            // Pre-fill the save section
            const multiplierLabel = isMultiplierMode ? ` (×${scaleFactor})` : '';
            const newServings = isMultiplierMode
                ? (scalingRecipe.servings ? `${scalingRecipe.servings} ×${scaleFactor}` : '')
                : document.getElementById('newYield').value;

            document.getElementById('scaledRecipeName').value = scalingRecipe.name + multiplierLabel;
            document.getElementById('scaledRecipeServings').value = newServings;
            document.getElementById('scaledTinShape').value = scalingRecipe.tinShape || '';
            document.getElementById('scaledTinSize').value = scalingRecipe.tinSize || '';
            document.getElementById('scaledTinNotes').value = scalingRecipe.tinNotes || '';
            document.getElementById('scaleSaveSection').style.display = 'block';
        }

        function saveScaledRecipe() {
            if (scaledIngredientsList.length === 0) {
                alert('Please calculate scaled ingredients first');
                return;
            }

            const newRecipe = {
                id: Date.now(),
                name: document.getElementById('scaledRecipeName').value || scalingRecipe.name + ' (Scaled)',
                category: scalingRecipe.category,
                description: scalingRecipe.description,
                source: scalingRecipe.source,
                instructions: scalingRecipe.instructions,
                servings: document.getElementById('scaledRecipeServings').value,
                tinShape: document.getElementById('scaledTinShape').value,
                tinSize: document.getElementById('scaledTinSize').value,
                tinNotes: document.getElementById('scaledTinNotes').value,
                ingredients: [...scaledIngredientsList],
                createdDate: new Date().toISOString()
            };

            recipes.push(newRecipe);
            localStorage.setItem('recipes', JSON.stringify(recipes));
            displayRecipes();
            closeScaleModal();
            alert('Scaled recipe saved!');
        }

        function printFullRecipe(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            const allergens = getRecipeAllergens(recipe);

            // Sort ingredients by numeric quantity (largest first)
            const sortedIngredients = [...recipe.ingredients].sort((a, b) => {
                const numA = parseFloat(a.amount) || 0;
                const numB = parseFloat(b.amount) || 0;
                return numB - numA; // Descending order (largest first)
            });

            const printContent = `
                <h1>${recipe.name}</h1>
                
                <div class="servings-box">
                    <strong>Yield:</strong> ${recipe.servings || 'Not specified'} | 
                    <strong>Category:</strong> ${recipe.category || 'Other'}
                    ${(recipe.tinShape || recipe.tinSize) ? ` | <strong>Tin:</strong> ${[recipe.tinShape, recipe.tinSize].filter(Boolean).join(' - ')}${recipe.tinNotes ? ` (${recipe.tinNotes})` : ''}` : ''}
                </div>
                
                ${recipe.description ? `<p style="font-size: 16px; color: #555; margin-bottom: 20px;"><em>${recipe.description}</em></p>` : ''}
                
                ${recipe.source ? `<p style="font-size: 14px; color: #666; margin-bottom: 15px;"><strong>Source:</strong> ${recipe.source}</p>` : ''}
                
                
                <h2>Ingredients</h2>
                <ul>
                    ${sortedIngredients.map(ing => {
                        const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                        if (!masterIng) return '';
                        const boldedComposition = masterIng.composition ? boldAllergensInText(masterIng.composition, allergens) : '';
                        return `
                            <li>
                                <strong>${ing.amount} ${masterIng.name}</strong>
                                ${boldedComposition ? `<div class="ingredient-composition">${boldedComposition}</div>` : ''}
                            </li>
                        `;
                    }).join('')}
                </ul>
                
                ${allergens.length > 0 ? `
                    <div class="allergen-warning">
                        <h3 style="margin-top: 0;">⚠️ ALLERGEN WARNING</h3>
                        <p>This recipe contains: ${allergens.join(', ')}</p>
                        <p style="font-size: 12px; margin-top: 5px;">Always verify ingredient compositions. Not liable for allergen-related incidents.</p>
                    </div>
                ` : ''}
                
                ${recipe.instructions ? `
                    <h2>Instructions</h2>
                    <div class="instructions">
                        ${recipe.instructions.replace(/\n/g, '<br>')}
                    </div>
                ` : ''}
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #999;">
                    Recipe from ${settings.businessName} | Printed on ${new Date().toLocaleDateString()}
                </div>
            `;

            document.getElementById('printContent').innerHTML = printContent;
            window.print();
        }

        function printSimpleLabel(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            const allergens = getRecipeAllergens(recipe);

            // Sort by quantity largest first
            const sortedIngredients = [...recipe.ingredients].sort((a, b) => {
                const numA = parseFloat(a.amount) || 0;
                const numB = parseFloat(b.amount) || 0;
                return numB - numA;
            });

            // Build a flat deduplicated list of items to print.
            // - If ingredient has a composition: split into individual sub-items and add each one
            //   (the ingredient name itself is dropped)
            // - If no composition: use the ingredient name as-is
            // Deduplication is case-insensitive across everything.
            const seenItems = new Set();
            const labelLines = [];

            sortedIngredients.forEach(ing => {
                const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                if (!masterIng) return;

                if (masterIng.composition && masterIng.composition.trim()) {
                    // Split composition by top-level commas only
                    // (respects brackets so "Palm Oil, Emulsifier (E322, E471)" splits correctly)
                    const parts = splitTopLevel(masterIng.composition);
                    parts.forEach(part => {
                        const clean = part.trim();
                        const key = clean.toLowerCase();
                        if (!seenItems.has(key)) {
                            seenItems.add(key);
                            labelLines.push({ text: clean, hasComposition: true });
                        }
                    });
                } else {
                    // No composition — just use the name
                    const key = masterIng.name.toLowerCase();
                    if (!seenItems.has(key)) {
                        seenItems.add(key);
                        labelLines.push({ text: masterIng.name, hasComposition: false });
                    }
                }
            });

            // Bold allergen keywords in each line
            const formattedLines = labelLines.map(line =>
                boldAllergensInText(line.text, allergens)
            );

            const printContent = `
                <h1>${recipe.name}</h1>
                
                <div class="servings-box">
                    <strong>Yield:</strong> ${recipe.servings || 'Not specified'}
                    ${(recipe.tinShape || recipe.tinSize) ? ` | <strong>Tin:</strong> ${[recipe.tinShape, recipe.tinSize].filter(Boolean).join(' - ')}${recipe.tinNotes ? ` (${recipe.tinNotes})` : ''}` : ''}
                </div>
                
                <h2>Ingredients</h2>
                <p style="font-size: 14px; line-height: 1.9; color: #333;">
                    ${formattedLines.join(', ')}
                </p>
                
                ${allergens.length > 0 ? `
                    <div class="allergen-warning">
                        <h3 style="margin-top: 0;">⚠️ ALLERGEN WARNING</h3>
                        <p>Contains: ${allergens.join(', ')}</p>
                    </div>
                ` : ''}
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #999;">
                    ${settings.businessName} | ${new Date().toLocaleDateString()}
                </div>
            `;

            document.getElementById('printContent').innerHTML = printContent;
            window.print();
        }

        // Splits a string by commas at the top level only (ignores commas inside brackets)
        function splitTopLevel(str) {
            const parts = [];
            let depth = 0;
            let current = '';
            for (let i = 0; i < str.length; i++) {
                const ch = str[i];
                if (ch === '(' || ch === '[') depth++;
                else if (ch === ')' || ch === ']') depth--;
                else if (ch === ',' && depth === 0) {
                    parts.push(current);
                    current = '';
                    continue;
                }
                current += ch;
            }
            if (current.trim()) parts.push(current);
            return parts;
        }


        function viewFullRecipe(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            const allergens = getRecipeAllergens(recipe);

            // Sort ingredients by quantity
            const sortedIngredients = [...recipe.ingredients].sort((a, b) => {
                const numA = parseFloat(a.amount) || 0;
                const numB = parseFloat(b.amount) || 0;
                return numB - numA;
            });

            const content = `
                <div style="margin-bottom: 20px;">
                    <span style="background: var(--color-teal); color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600;">${recipe.category || 'Other'}</span>
                </div>

                <div style="background: var(--color-bg-light); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--color-teal);">
                    <p style="margin: 0 0 8px 0;"><strong>Yield:</strong> ${recipe.servings || 'Not specified'}</p>
                    ${(recipe.tinShape || recipe.tinSize) ? `<p style="margin: 0 0 8px 0;"><strong>Tin:</strong> ${[recipe.tinShape, recipe.tinSize].filter(Boolean).join(' - ')}${recipe.tinNotes ? ` (${recipe.tinNotes})` : ''}</p>` : ''}
                    ${recipe.description ? `<p style="margin: 0; color: #555;"><em>${recipe.description}</em></p>` : ''}
                    ${recipe.source ? `<p style="margin: 8px 0 0 0; font-size: 13px; color: #999;"><strong>Source:</strong> ${recipe.source}</p>` : ''}
                </div>

                <h4 style="color: var(--color-accent); margin-bottom: 12px;">Ingredients</h4>
                <ul style="list-style: none; padding: 0; margin-bottom: 24px;">
                    ${sortedIngredients.map(ing => {
                        const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                        return masterIng ? `<li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;"><strong>${ing.amount}</strong> ${masterIng.name}</li>` : '';
                    }).join('')}
                </ul>

                ${allergens.length > 0 ? `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 24px;">
                        <p style="margin: 0; font-weight: 600; color: #856404;">⚠️ Allergens: ${allergens.join(', ')}</p>
                    </div>
                ` : ''}

                ${recipe.instructions ? `
                    <h4 style="color: var(--color-accent); margin-bottom: 12px;">Instructions</h4>
                    <div style="white-space: pre-wrap; line-height: 1.8; color: #333;">${recipe.instructions}</div>
                ` : ''}
            `;

            document.getElementById('viewRecipeName').textContent = recipe.name;
            document.getElementById('viewRecipeContent').innerHTML = content;
            document.getElementById('viewModal').classList.add('active');
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('active');
        }

        // Edit Recipe Modal Functions
        let editingRecipeId = null;

        function openEditModal(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            editingRecipeId = recipeId;

            // Populate form fields
            document.getElementById('editRecipeName').value = recipe.name;
            document.getElementById('editRecipeCategory').value = recipe.category || 'Other';
            document.getElementById('editRecipeDescription').value = recipe.description || '';
            document.getElementById('editRecipeSource').value = recipe.source || '';
            document.getElementById('editRecipeInstructions').value = recipe.instructions || '';
            document.getElementById('editRecipeServings').value = recipe.servings || '';
            document.getElementById('editTinShape').value = recipe.tinShape || '';
            document.getElementById('editTinSize').value = recipe.tinSize || '';
            document.getElementById('editTinNotes').value = recipe.tinNotes || '';

            // Display ingredients (read-only for now - full ingredient editing is complex)
            const ingredientsList = recipe.ingredients.map(ing => {
                const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                return masterIng ? `<div style="padding: 8px; background: var(--color-bg-light); border-radius: 6px; margin-bottom: 8px;">
                    <strong>${ing.amount}</strong> ${masterIng.name}
                </div>` : '';
            }).join('');

            document.getElementById('editIngredientsList').innerHTML = ingredientsList + 
                '<p style="color: #999; font-size: 13px; margin-top: 10px;">Note: To change ingredients, create a new recipe or duplicate this one.</p>';

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingRecipeId = null;
        }

        function saveEditedRecipe() {
            if (!editingRecipeId) return;

            const recipe = recipes.find(r => r.id === editingRecipeId);
            if (!recipe) return;

            // Update recipe fields
            recipe.name = document.getElementById('editRecipeName').value;
            recipe.category = document.getElementById('editRecipeCategory').value;
            recipe.description = document.getElementById('editRecipeDescription').value;
            recipe.source = document.getElementById('editRecipeSource').value;
            recipe.instructions = document.getElementById('editRecipeInstructions').value;
            recipe.servings = document.getElementById('editRecipeServings').value;
            recipe.tinShape = document.getElementById('editTinShape').value;
            recipe.tinSize = document.getElementById('editTinSize').value;
            recipe.tinNotes = document.getElementById('editTinNotes').value;

            // Save to localStorage
            localStorage.setItem('recipes', JSON.stringify(recipes));

            closeEditModal();
            displayRecipes();
            alert('Recipe updated successfully!');
        }

        // Backup warning banner
        function dismissBackupWarning() {
            document.getElementById('backupWarning').style.display = 'none';
            localStorage.setItem('backupWarningDismissed', 'true');
        }

        // Check if backup warning should be shown
        function checkBackupWarning() {
            const dismissed = localStorage.getItem('backupWarningDismissed');
            if (dismissed) {
                document.getElementById('backupWarning').style.display = 'none';
            }
        }

        // Selection management
        function toggleRecipeSelection(recipeId) {
            if (selectedRecipeIds.has(recipeId)) {
                selectedRecipeIds.delete(recipeId);
            } else {
                selectedRecipeIds.add(recipeId);
            }
            updateActionButtons();
            displayRecipes();
        }

        function toggleSelectMode() {
            selectMode = !selectMode;
            const btn = document.getElementById('btnSelectMode');
            
            if (selectMode) {
                btn.textContent = '✕ View Mode';
                btn.style.background = '#e0e0e0';
                btn.style.color = 'var(--color-text)';
            } else {
                btn.textContent = '☑ Select Mode';
                btn.style.background = 'var(--color-teal)';
                btn.style.color = 'white';
                // Clear selections when exiting select mode
                selectedRecipeIds.clear();
                updateActionButtons();
            }
            
            displayRecipes();
        }

        function selectAllRecipes() {
            recipes.forEach(r => selectedRecipeIds.add(r.id));
            updateActionButtons();
            displayRecipes();
        }

        function deselectAllRecipes() {
            selectedRecipeIds.clear();
            updateActionButtons();
            displayRecipes();
        }

        function updateActionButtons() {
            const count = selectedRecipeIds.size;
            const isSingle = count === 1;
            const hasSelection = count > 0;

            // Update counter
            document.getElementById('selectedCount').textContent = count;

            // Update button states and labels
            document.getElementById('btnView').disabled = !hasSelection;
            document.getElementById('btnEdit').disabled = !isSingle;
            document.getElementById('btnDuplicate').disabled = !isSingle;
            document.getElementById('btnPrintFull').disabled = !hasSelection;
            document.getElementById('btnPrintList').disabled = !hasSelection;
            document.getElementById('btnScale').disabled = !isSingle;
            document.getElementById('btnBatch').disabled = !isSingle;
            document.getElementById('btnDelete').disabled = !hasSelection;

            // Update counts in button labels
            document.getElementById('viewCount').textContent = count > 1 ? `(${count})` : '';
            document.getElementById('printFullCount').textContent = count > 1 ? `(${count})` : '';
            document.getElementById('printListCount').textContent = count > 1 ? `(${count})` : '';
            document.getElementById('deleteCount').textContent = count > 1 ? `(${count})` : '';
        }

        // Action functions
        function viewSelectedRecipes() {
            if (selectedRecipeIds.size === 0) return;
            
            const selectedRecipes = recipes.filter(r => selectedRecipeIds.has(r.id));
            
            if (selectedRecipes.length === 1) {
                viewFullRecipe(selectedRecipes[0].id);
            } else {
                // View multiple recipes in one modal
                viewMultipleRecipes(selectedRecipes);
            }
        }

        function viewMultipleRecipes(selectedRecipes) {
            const content = selectedRecipes.map(recipe => {
                const allergens = getRecipeAllergens(recipe);
                const sortedIngredients = [...recipe.ingredients].sort((a, b) => {
                    const numA = parseFloat(a.amount) || 0;
                    const numB = parseFloat(b.amount) || 0;
                    return numB - numA;
                });

                return `
                    <div style="margin-bottom: 40px; padding-bottom: 40px; border-bottom: 3px solid var(--color-border);">
                        <h2 style="color: var(--color-accent); margin-bottom: 15px;">${recipe.name}</h2>
                        
                        <div style="background: var(--color-bg-light); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--color-teal);">
                            <span style="background: var(--color-teal); color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; margin-right: 10px;">${recipe.category || 'Other'}</span>
                            <p style="margin: 8px 0 0 0;"><strong>Yield:</strong> ${recipe.servings || 'Not specified'}</p>
                            ${(recipe.tinShape || recipe.tinSize) ? `<p style="margin: 8px 0 0 0;"><strong>Tin:</strong> ${[recipe.tinShape, recipe.tinSize].filter(Boolean).join(' - ')}${recipe.tinNotes ? ` (${recipe.tinNotes})` : ''}</p>` : ''}
                            ${recipe.description ? `<p style="margin: 8px 0 0 0; color: #555;"><em>${recipe.description}</em></p>` : ''}
                        </div>

                        <h4 style="color: var(--color-accent); margin-bottom: 12px;">Ingredients</h4>
                        <ul style="list-style: none; padding: 0; margin-bottom: 20px;">
                            ${sortedIngredients.map(ing => {
                                const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                                return masterIng ? `<li style="padding: 6px 0; border-bottom: 1px solid #f0f0f0;"><strong>${ing.amount}</strong> ${masterIng.name}</li>` : '';
                            }).join('')}
                        </ul>

                        ${allergens.length > 0 ? `
                            <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                                <p style="margin: 0; font-weight: 600; color: #856404;">⚠️ Allergens: ${allergens.join(', ')}</p>
                            </div>
                        ` : ''}

                        ${recipe.instructions ? `
                            <h4 style="color: var(--color-accent); margin-bottom: 12px;">Instructions</h4>
                            <div style="white-space: pre-wrap; line-height: 1.8; color: #333;">${recipe.instructions}</div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('viewRecipeName').textContent = `${selectedRecipes.length} Recipes`;
            document.getElementById('viewRecipeContent').innerHTML = content;
            document.getElementById('viewModal').classList.add('active');
        }

        function editSelectedRecipe() {
            if (selectedRecipeIds.size !== 1) return;
            const recipeId = Array.from(selectedRecipeIds)[0];
            openEditModal(recipeId);
        }

        function duplicateSelectedRecipe() {
            if (selectedRecipeIds.size !== 1) return;
            const recipeId = Array.from(selectedRecipeIds)[0];
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            const duplicated = {
                ...recipe,
                id: Date.now(),
                name: recipe.name + ' (Copy)',
                createdDate: new Date().toISOString()
            };

            recipes.push(duplicated);
            localStorage.setItem('recipes', JSON.stringify(recipes));
            displayRecipes();
            alert(`Duplicated "${recipe.name}"`);
        }

        function printSelectedFull() {
            if (selectedRecipeIds.size === 0) return;
            
            const selectedRecipes = recipes.filter(r => selectedRecipeIds.has(r.id));
            
            if (selectedRecipes.length === 1) {
                printFullRecipe(selectedRecipes[0].id);
            } else {
                printMultipleFullRecipes(selectedRecipes);
            }
        }

        function printMultipleFullRecipes(selectedRecipes) {
            const printContent = selectedRecipes.map(recipe => {
                const allergens = getRecipeAllergens(recipe);
                const sortedIngredients = [...recipe.ingredients].sort((a, b) => {
                    const numA = parseFloat(a.amount) || 0;
                    const numB = parseFloat(b.amount) || 0;
                    return numB - numA;
                });

                return `
                    <div style="page-break-after: always;">
                        <h1>${recipe.name}</h1>
                        
                        <div class="servings-box">
                            <strong>Yield:</strong> ${recipe.servings || 'Not specified'} | 
                            <strong>Category:</strong> ${recipe.category || 'Other'}
                            ${(recipe.tinShape || recipe.tinSize) ? ` | <strong>Tin:</strong> ${[recipe.tinShape, recipe.tinSize].filter(Boolean).join(' - ')}${recipe.tinNotes ? ` (${recipe.tinNotes})` : ''}` : ''}
                        </div>
                        
                        ${recipe.description ? `<p style="font-size: 16px; color: #555; margin-bottom: 20px;"><em>${recipe.description}</em></p>` : ''}
                        ${recipe.source ? `<p style="font-size: 14px; color: #666; margin-bottom: 15px;"><strong>Source:</strong> ${recipe.source}</p>` : ''}
                        
                        <h2>Ingredients</h2>
                        <ul>
                            ${sortedIngredients.map(ing => {
                                const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                                if (!masterIng) return '';
                                const boldedComposition = masterIng.composition ? boldAllergensInText(masterIng.composition, allergens) : '';
                                return `
                                    <li>
                                        <strong>${ing.amount} ${masterIng.name}</strong>
                                        ${boldedComposition ? `<div class="ingredient-composition">${boldedComposition}</div>` : ''}
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                        
                        ${recipe.instructions ? `
                            <h2>Instructions</h2>
                            <div style="white-space: pre-wrap; line-height: 1.8;">${recipe.instructions}</div>
                        ` : ''}
                        
                        ${allergens.length > 0 ? `
                            <div class="allergen-warning">
                                <h3>⚠️ ALLERGEN WARNING</h3>
                                <p><strong>Contains:</strong> ${allergens.join(', ')}</p>
                                <p style="font-size: 12px; margin-top: 10px;">Always verify allergen information with ingredient suppliers. This business is not liable for allergen-related incidents.</p>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #999;">
                            ${settings.businessName} | ${new Date().toLocaleDateString()}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('printContent').innerHTML = printContent;
            window.print();
        }

        function printSelectedList() {
            if (selectedRecipeIds.size === 0) return;
            
            const selectedRecipes = recipes.filter(r => selectedRecipeIds.has(r.id));
            
            if (selectedRecipes.length === 1) {
                printSimpleLabel(selectedRecipes[0].id);
            } else {
                printMultipleLabels(selectedRecipes);
            }
        }

        function printMultipleLabels(selectedRecipes) {
            const printContent = selectedRecipes.map(recipe => {
                const allergens = getRecipeAllergens(recipe);
                const sortedIngredients = [...recipe.ingredients].sort((a, b) => {
                    const numA = parseFloat(a.amount) || 0;
                    const numB = parseFloat(b.amount) || 0;
                    return numB - numA;
                });

                const seenItems = new Set();
                const labelLines = [];

                sortedIngredients.forEach(ing => {
                    const masterIng = masterIngredients.find(m => m.id === ing.masterIngredientId);
                    if (!masterIng) return;

                    if (masterIng.composition && masterIng.composition.trim()) {
                        const parts = splitTopLevel(masterIng.composition);
                        parts.forEach(part => {
                            const clean = part.trim();
                            const key = clean.toLowerCase();
                            if (!seenItems.has(key)) {
                                seenItems.add(key);
                                labelLines.push(clean);
                            }
                        });
                    } else {
                        const key = masterIng.name.toLowerCase();
                        if (!seenItems.has(key)) {
                            seenItems.add(key);
                            labelLines.push(masterIng.name);
                        }
                    }
                });

                const formattedLines = labelLines.map(line => boldAllergensInText(line, allergens));

                return `
                    <div style="page-break-after: always; padding: 20px;">
                        <h1>${recipe.name}</h1>
                        
                        <div class="servings-box">
                            <strong>Yield:</strong> ${recipe.servings || 'Not specified'}
                            ${(recipe.tinShape || recipe.tinSize) ? ` | <strong>Tin:</strong> ${[recipe.tinShape, recipe.tinSize].filter(Boolean).join(' - ')}${recipe.tinNotes ? ` (${recipe.tinNotes})` : ''}` : ''}
                        </div>
                        
                        <h2>Ingredients</h2>
                        <p style="font-size: 14px; line-height: 1.9; color: #333;">
                            ${formattedLines.join(', ')}
                        </p>
                        
                        ${allergens.length > 0 ? `
                            <div class="allergen-warning">
                                <h3 style="margin-top: 0;">⚠️ ALLERGEN WARNING</h3>
                                <p>Contains: ${allergens.join(', ')}</p>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #999;">
                            ${settings.businessName} | ${new Date().toLocaleDateString()}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('printContent').innerHTML = printContent;
            window.print();
        }

        function scaleSelectedRecipe() {
            if (selectedRecipeIds.size !== 1) return;
            const recipeId = Array.from(selectedRecipeIds)[0];
            openScaleModal(recipeId);
        }

        function batchSelectedRecipe() {
            if (selectedRecipeIds.size !== 1) return;
            const recipeId = Array.from(selectedRecipeIds)[0];
            openBatchModal(recipeId);
        }

        function deleteSelectedRecipes() {
            if (selectedRecipeIds.size === 0) return;
            
            const count = selectedRecipeIds.size;
            const message = count === 1 
                ? 'Are you sure you want to delete this recipe?' 
                : `Are you sure you want to delete ${count} recipes?`;
            
            if (confirm(message)) {
                recipes = recipes.filter(r => !selectedRecipeIds.has(r.id));
                localStorage.setItem('recipes', JSON.stringify(recipes));
                selectedRecipeIds.clear();
                updateActionButtons();
                displayRecipes();
            }
        }

        function deleteRecipe(recipeId) {
            if (confirm('Are you sure you want to delete this recipe?')) {
                recipes = recipes.filter(r => r.id !== recipeId);
                localStorage.setItem('recipes', JSON.stringify(recipes));
                displayRecipes();
            }
        }

        // Allergen Table Export Functions
        function exportAllergenTable(format) {
            if (recipes.length === 0) {
                alert('No recipes to export! Create some recipes first.');
                return;
            }

            if (format === 'excel') {
                exportAllergenToExcel();
            } else if (format === 'pdf') {
                exportAllergenToPDF();
            }
        }

        function exportAllergenToExcel() {
            // Create CSV (Excel-compatible)
            let csv = 'Recipe Name,Category,Allergens\n';
            
            recipes.forEach(recipe => {
                const allergens = getRecipeAllergens(recipe);
                const allergenIcon = allergens.length > 0 ? ' ⚠️' : '';
                const allergenList = allergens.length > 0 ? allergens.join('; ') : 'None';
                const name = recipe.name.replace(/"/g, '""'); // Escape quotes
                const category = (recipe.category || 'Other').replace(/"/g, '""');
                
                csv += `"${name}","${category}","${allergenList}"\n`;
            });
            
            // Download as CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${settings.businessName.replace(/\s+/g, '-')}-allergen-table-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Allergen table exported as Excel/CSV file!');
        }

        function exportAllergenToPDF() {
            // Create printable HTML for PDF
            let html = `
                <html>
                <head>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 30px; }
                        h1 { color: #2b7a8e; margin-bottom: 10px; font-family: Georgia, 'Times New Roman', serif; }
                        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #81c9c9; color: white; font-weight: 600; }
                        tr:nth-child(even) { background-color: #f8fcfc; }
                        tr:hover { background-color: #f0f8f8; }
                        .allergen { background: #f5c6d6; color: #8b4561; padding: 3px 8px; border-radius: 3px; margin: 2px; display: inline-block; font-size: 11px; font-weight: 600; }
                        .no-allergen { color: #4caf50; font-style: italic; }
                        .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; color: #999; font-size: 12px; }
                        @media print {
                            body { padding: 20px; }
                            tr:hover { background-color: transparent !important; }
                        }
                    </style>
                </head>
                <body>
                    <h1>${settings.businessName} - Allergen Reference Table</h1>
                    <p class="subtitle">Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40%;">Recipe Name</th>
                                <th style="width: 20%;">Category</th>
                                <th style="width: 40%;">Allergens</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            recipes.forEach(recipe => {
                const allergens = getRecipeAllergens(recipe);
                const allergenIcon = allergens.length > 0 ? ' ⚠️' : '';
                const allergenHTML = allergens.length > 0 
                    ? allergens.map(a => `<span class="allergen">${a}</span>`).join(' ')
                    : '<span class="no-allergen">None</span>';
                
                html += `
                    <tr>
                        <td><strong>${recipe.name}</strong></td>
                        <td>${recipe.category || 'Other'}</td>
                        <td>${allergenHTML}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    <div class="footer">
                        <p><strong>${settings.businessName}</strong></p>
                        <p>Always verify allergen information with ingredient suppliers and manufacturers.</p>
                        <p>This table is for reference only. The business is responsible for ensuring allergen accuracy.</p>
                    </div>
                </body>
                </html>
            `;
            
            // Open in new window for printing to PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            
            // Trigger print dialog (user can save as PDF)
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // Event listeners
        document.getElementById('ingredientAmount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addIngredientToRecipe();
            }
        });

        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        document.getElementById('scaleModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeScaleModal();
            }
        });

        document.getElementById('viewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeViewModal();
            }
        });

        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Initialize on load
        initializeApp();
        checkBackupWarning();
        updateActionButtons();
    </script>

    <!-- License Key System -->
    <script>
        // License Key Management
        let licenseKey = localStorage.getItem('bakebase_license');
        let licenseVerified = localStorage.getItem('bakebase_verified') === 'true';

        // Check license on load
        function checkLicense() {
            // If no license or not verified, show activation modal
            if (!licenseKey || !licenseVerified) {
                showActivationModal();
            }
        }

        function showActivationModal() {
            const modal = document.createElement('div');
            modal.id = 'licenseModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <h2 style="color: #81c9c9; margin-bottom: 20px; text-align: center;">Activate BakeBase</h2>
                    <p style="color: #666; margin-bottom: 20px; text-align: center;">Enter your license key to activate BakeBase</p>
                    <input type="text" id="licenseInput" placeholder="XXXX-XXXX-XXXX-XXXX" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; text-align: center; font-family: monospace; margin-bottom: 15px;">
                    <div id="licenseError" style="color: #e74c3c; text-align: center; margin-bottom: 10px; display: none;"></div>
                    <button onclick="activateLicense()" style="width: 100%; padding: 14px; background: #81c9c9; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px;">Activate</button>
                    <button onclick="skipActivation()" style="width: 100%; padding: 12px; background: transparent; color: #999; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; cursor: pointer;">Skip (Trial Mode - 7 days)</button>
                    <p style="color: #999; font-size: 12px; text-align: center; margin-top: 15px;">Need a license key? Visit <a href="https://youretsy.com" target="_blank" style="color: #81c9c9;">your purchase page</a></p>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function activateLicense() {
            const input = document.getElementById('licenseInput');
            const error = document.getElementById('licenseError');
            const key = input.value.trim().toUpperCase();
            
            // Validate license key format
            if (!key.match(/^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/)) {
                error.textContent = 'Invalid license key format. Use: XXXX-XXXX-XXXX-XXXX';
                error.style.display = 'block';
                return;
            }
            
            // Verify license key (simple checksum validation)
            if (verifyLicenseKey(key)) {
                localStorage.setItem('bakebase_license', key);
                localStorage.setItem('bakebase_verified', 'true');
                localStorage.setItem('bakebase_activated', Date.now());
                
                document.getElementById('licenseModal').remove();
                alert('✅ License activated successfully!\n\nThank you for purchasing BakeBase.');
            } else {
                error.textContent = 'Invalid license key. Please check and try again.';
                error.style.display = 'block';
            }
        }

        function skipActivation() {
            // Set trial mode for 7 days
            localStorage.setItem('bakebase_trial', 'true');
            localStorage.setItem('bakebase_trial_start', Date.now());
            document.getElementById('licenseModal').remove();
            checkTrialExpiry();
        }

        function checkTrialExpiry() {
            const trialStart = parseInt(localStorage.getItem('bakebase_trial_start'));
            if (trialStart) {
                const daysElapsed = (Date.now() - trialStart) / (1000 * 60 * 60 * 24);
                if (daysElapsed > 7) {
                    alert('⚠️ Your 7-day trial has expired.\n\nPlease enter your license key to continue using BakeBase.');
                    showActivationModal();
                }
            }
        }

        function verifyLicenseKey(key) {
            // Simple checksum validation
            // Format: XXXX-XXXX-XXXX-XXXX
            // Last segment is a checksum of first 3 segments
            
            const parts = key.split('-');
            if (parts.length !== 4) return false;
            
            // Calculate checksum
            const data = parts[0] + parts[1] + parts[2];
            let sum = 0;
            for (let i = 0; i < data.length; i++) {
                sum += data.charCodeAt(i);
            }
            
            // Convert checksum to 4-char hex
            const checksum = sum.toString(16).toUpperCase().padStart(4, '0').slice(-4);
            
            return parts[3] === checksum;
        }

        // Run license check after a short delay (so app loads first)
        setTimeout(checkLicense, 1000);
        
        // Check trial expiry if in trial mode
        if (localStorage.getItem('bakebase_trial') === 'true') {
            checkTrialExpiry();
        }
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('BakeBase: Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.log('BakeBase: Service Worker registration failed:', error);
                    });
            });
        }

        // Install prompt for PWA
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button/banner (optional)
            showInstallPromotion();
        });

        function showInstallPromotion() {
            // Only show if not already installed and not dismissed
            if (localStorage.getItem('pwa_install_dismissed') === 'true') return;
            if (window.matchMedia('(display-mode: standalone)').matches) return;
            
            const banner = document.createElement('div');
            banner.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                right: 20px;
                background: #81c9c9;
                color: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: space-between;
                z-index: 9999;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            `;
            
            banner.innerHTML = `
                <div>
                    <strong style="display: block; margin-bottom: 5px;">Install BakeBase</strong>
                    <span style="font-size: 13px; opacity: 0.9;">Add to home screen for quick access</span>
                </div>
                <div>
                    <button onclick="installPWA()" style="background: white; color: #81c9c9; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 10px;">Install</button>
                    <button onclick="dismissInstallPromotion()" style="background: transparent; color: white; border: 1px solid white; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Not Now</button>
                </div>
            `;
            
            banner.id = 'installBanner';
            document.body.appendChild(banner);
        }

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('BakeBase: PWA installed');
                    }
                    deferredPrompt = null;
                    dismissInstallPromotion();
                });
            }
        }

        function dismissInstallPromotion() {
            const banner = document.getElementById('installBanner');
            if (banner) banner.remove();
            localStorage.setItem('pwa_install_dismissed', 'true');
        }

        // Detect if already installed
        window.addEventListener('appinstalled', () => {
            console.log('BakeBase: PWA was installed');
            dismissInstallPromotion();
        });
    </script>

    <footer style="
        text-align: center;
        padding: 20px;
        margin-top: 30px;
        color: rgba(43, 122, 142, 0.6);
        font-size: 12px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    ">
        © 2026 BakeBase &nbsp;|&nbsp; Version 1.3 &nbsp;|&nbsp; <a href="/cdn-cgi/l/email-protection#771f121b1b183715161c121516041259141859021c" style="color: rgba(43, 122, 142, 0.6); text-decoration: none;"><span class=